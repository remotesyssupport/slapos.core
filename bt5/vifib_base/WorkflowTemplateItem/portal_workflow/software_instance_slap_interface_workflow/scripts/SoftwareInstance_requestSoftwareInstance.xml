<?xml version="1.0"?>
<ZopeData>
  <record id="1" aka="AAAAAAAAAAE=">
    <pickle>
      <global name="PythonScript" module="Products.PythonScripts.PythonScript"/>
    </pickle>
    <pickle>
      <dictionary>
        <item>
            <key> <string>Script_magic</string> </key>
            <value> <int>3</int> </value>
        </item>
        <item>
            <key> <string>_bind_names</string> </key>
            <value>
              <object>
                <klass>
                  <global name="NameAssignments" module="Shared.DC.Scripts.Bindings"/>
                </klass>
                <tuple/>
                <state>
                  <dictionary>
                    <item>
                        <key> <string>_asgns</string> </key>
                        <value>
                          <dictionary>
                            <item>
                                <key> <string>name_container</string> </key>
                                <value> <string>container</string> </value>
                            </item>
                            <item>
                                <key> <string>name_context</string> </key>
                                <value> <string>context</string> </value>
                            </item>
                            <item>
                                <key> <string>name_m_self</string> </key>
                                <value> <string>script</string> </value>
                            </item>
                            <item>
                                <key> <string>name_subpath</string> </key>
                                <value> <string>traverse_subpath</string> </value>
                            </item>
                          </dictionary>
                        </value>
                    </item>
                  </dictionary>
                </state>
              </object>
            </value>
        </item>
        <item>
            <key> <string>_body</string> </key>
            <value> <string encoding="cdata"><![CDATA[

software_instance = state_change[\'object\']\n
portal = software_instance.getPortalObject()\n
# Get required arguments\n
kwargs = state_change.kwargs\n
software_release_url_string = state_change.kwargs[\'software_release\']\n
requested_partition_reference = kwargs["partition_reference"]\n
shared = kwargs["shared"]\n
software_type = kwargs["software_type"]\n
instance_xml = kwargs["instance_xml"]\n
filter_kw = kwargs["filter_kw"]\n
\n
# Get root software instance\n
predecessor_software_instance = software_instance\n
while (predecessor_software_instance is not None):\n
  root_software_instance = predecessor_software_instance\n
  predecessor_software_instance = predecessor_software_instance.getPredecessorRelatedValue(\n
      portal_type="Software Instance")\n
\n
tag = "%s_%s_%s_inProgress" % (root_software_instance.getUid(), software_type,\n
                               requested_partition_reference)\n
\n
# Check if it already exists\n
request_software_instance = software_instance.portal_catalog.getResultValue(\n
  portal_type=\'Software Instance\',\n
  # XXX: User based property is used in non manual operation\n
  # XXX-2: Do we really need to use root_uid?\n
  title=requested_partition_reference,\n
  source_reference=software_type,\n
  root_uid=root_software_instance.getUid(),\n
)\n
\n
if (request_software_instance is None):\n
  if (portal.portal_activities.countMessageWithTag(tag) > 0):\n
    # The software instance is already under creation but can not be fetched from catalog\n
    # As it is not possible to fetch informations, it is better to raise an error\n
    raise NotImplementedError(tag)\n
  else:\n
    # First time that the software instance is requested\n
    # Create a new one\n
    module = software_instance.getDefaultModule(portal_type="Software Instance")\n
    request_software_instance = module.newContent(\n
      portal_type="Software Instance",\n
      title=requested_partition_reference,\n
      source_reference=software_type,\n
      text_content=instance_xml,\n
      activate_kw={\'tag\': tag},\n
      **portal.Base_getNewSoftwareInstanceCoordinate()\n
    )\n
    request_software_instance.portal_workflow.doActionFor(request_software_instance, \'validate_action\')\n
    sale_packing_list_line = context.SoftwareInstance_getInstanceSetupPackingListLine(state_change)\n
    hosting_subscription_uid = sale_packing_list_line.getAggregateValue(portal_type=\'Hosting Subscription\').getUid()\n
    request_software_instance.requestComputerPartition(\n
      software_release=software_release_url_string,\n
      hosting_subscription_uid=hosting_subscription_uid,\n
      shared=shared,\n
      software_type=software_type,\n
      tag=tag)\n
else:\n
  # Update existing software instance\n
  # Sale Packing List interaction has to be requested automatically with an interaction workflow\n
  request_software_instance.edit(\n
    text_content=instance_xml,\n
    activate_kw={\'tag\': tag},\n
  )\n
  # Update the predecessor category of the original caller\n
  predecessor_software_instance = request_software_instance.getPredecessorRelatedValue(\n
    portal_type="Software Instance")\n
  if predecessor_software_instance is None:\n
    raise ValueError(\'Requested Software Instance %s should have a predecessor\' % request_software_instance.getRelativeUrl())\n
  else:\n
    predecessor_uid_list = predecessor_software_instance.getPredecessorUidList()\n
    predecessor_uid_list.remove(request_software_instance.getUid())\n
    predecessor_software_instance.edit(\n
      predecessor_uid_list=predecessor_uid_list,\n
      activate_kw={\'tag\': tag},)\n
\n
predecessor_list = software_instance.getPredecessorList() + [request_software_instance.getRelativeUrl()]\n
software_instance.edit(\n
  predecessor_list=predecessor_list,\n
  activate_kw={\'tag\': tag},)\n


]]></string> </value>
        </item>
        <item>
            <key> <string>_params</string> </key>
            <value> <string>state_change</string> </value>
        </item>
        <item>
            <key> <string>id</string> </key>
            <value> <string>SoftwareInstance_requestSoftwareInstance</string> </value>
        </item>
      </dictionary>
    </pickle>
  </record>
</ZopeData>
